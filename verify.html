<h2>Certificate Verification</h2>

<input id="reg" placeholder="Enter Register Number">
<button onclick="verify()">Verify</button>

<div id="result"></div>

<script type="module">
import { db } from './js/firebase-config.js';
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Main verify function
window.verify = async function(regOverride = null) {

    const regNum = regOverride || document.getElementById('reg').value.trim();

    if(!regNum){
        alert("Enter Register Number");
        return;
    }

    // Set value in textbox (important for URL mode)
    document.getElementById('reg').value = regNum;

    const ref = doc(db, "students", regNum);
    const snap = await getDoc(ref);

    const result = document.getElementById('result');

    if(snap.exists()){

        const student = snap.data();

        result.innerHTML = `
            <h3>Verified ✅</h3>

            <img src="${student.imageUrl || 'https://via.placeholder.com/120'}"
            style="width:120px;height:120px;border-radius:50%;object-fit:cover">

            <p><b>Name:</b> ${student.name}</p>
            <p><b>Register No:</b> ${regNum}</p>
            <p><b>Course:</b> ${student.course}</p>
            <p><b>Email:</b> ${student.email}</p>
            <p><b>Graduation Date:</b> ${student.graduationDate || 'Not Available'}</p>

        `;

    } else {

        result.innerHTML = "<h3>❌ Certificate Not Found</h3>";

    }

};


// Auto-load when opening link with ?reg=
window.addEventListener("DOMContentLoaded", () => {

    const params = new URLSearchParams(window.location.search);

    const reg = params.get("reg");

    if(reg){

        verify(reg); // THIS IS THE IMPORTANT FIX

    }

});
</script>